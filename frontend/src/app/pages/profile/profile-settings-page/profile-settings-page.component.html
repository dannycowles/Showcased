<div class="container text-white pt-5" style="margin-bottom: 15vh">
  <a class="d-inline-flex align-items-center gap-3 mb-5 text-decoration-none text-reset" [routerLink]="['..']">
    <img ngSrc="chevron-left.svg" alt="" height="40" width="40">
    <h3>Back to profile</h3>
  </a>
  <h2 class="mb-5">Account Settings</h2>

  <ul class="nav nav-tabs custom-tabs mb-5" id="settingsTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile-tab-pane"
              type="button" role="tab" aria-controls="profile-tab-pane" aria-selected="true">
        Profile
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="avatar-tab" data-bs-toggle="tab" data-bs-target="#avatar-tab-pane"
              type="button" role="tab" aria-controls="avatar-tab-pane" aria-selected="false">
        Avatar
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="auth-tab" data-bs-toggle="tab" data-bs-target="#auth-tab-pane"
              type="button" role="tab" aria-controls="auth-tab-pane" aria-selected="false">
        Auth
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="social-tab" data-bs-toggle="tab" data-bs-target="#social-tab-pane"
              type="button" role="tab" aria-controls="social-tab-pane" aria-selected="false">
        Social
      </button>
    </li>
  </ul>

  <div class="tab-content" id="settingsTabsContent">
    <div class="tab-pane show active" id="profile-tab-pane" role="tabpanel" aria-labelledby="profile-tab" tabindex="0">
      <h3 class="mb-4">Profile</h3>
      @if (profileSettings) {
        <div class="mb-3 w-50">
          <label for="usernameInput" class="form-label">Username</label>
          <input type="text" class="form-control ps-2" id="usernameInput" [value]="profileSettings.displayName" aria-label="Disabled username input" disabled>
        </div>

        <div class="mb-3 w-50">
          <label for="emailInput" class="form-label">Email</label>
          <input type="text" class="form-control ps-2" id="emailInput" [value]="profileSettings.email" aria-label="Disabled email input" disabled>
        </div>

        <div class="mb-3 w-50">
          <label for="bioInput" class="form-label">Bio</label>
          <textarea class="form-control ps-2" [formControl]="bio" id="bioInput" rows="5" aria-describedby="bioHelpBlock"></textarea>
          <div id="bioHelpBlock" class="form-text text-reset">
            {{maxBioLength - bio.value.length}} characters remaining.
          </div>
        </div>
        <p class="validation-success fs-5">{{saveMessage}}</p>
        <button type="button" [disabled]="isProfileSaveDisabled()" class="btn btn-primary mt-3 button" (click)="saveProfileChanges()">Save Changes</button>
      }
    </div>

    <div class="tab-pane" id="avatar-tab-pane" role="tabpanel" aria-labelledby="avatar-tab" tabindex="0">
      @if (profileSettings) {
        <div class="d-flex flex-column">
          <h3 class="mb-4">Avatar</h3>
          <div class="d-flex flex-column align-items-center align-self-start gap-3">
            <img id="profile-picture" [ngSrc]="profileSettings.profilePicture" alt="Profile Picture" width="400" height="400" priority>
            <input type="file" accept="image/jpeg, image/png" required (change)="onFileSelected($event)">
            <p class="fs-5" [ngClass]="avatarUploadSuccess ? 'validation-success' : 'validation-error'" >{{avatarMessage}}</p>
          </div>
        </div>
      }
    </div>

    <div class="tab-pane" id="auth-tab-pane" role="tabpanel" aria-labelledby="auth-tab" tabindex="0">
      <div class="w-50">
        <h3 class="mb-4">Change password</h3>
        <form [formGroup]="changePasswordForm" (ngSubmit)="changePassword()">
          <div class="mb-4">
            <label for="current-password" class="form-label">Current password</label>
            <input id="current-password" type="password" class="form-control ps-2" placeholder="Enter current password" formControlName="currentPassword"
                   [class.is-invalid]="currentPassword.invalid && (currentPassword.dirty || currentPassword.touched)">
            @if (currentPassword.invalid && (currentPassword.dirty || currentPassword.touched)) {
              @if (currentPassword.hasError('required')) {
                <div class="validation-error">Current password is required</div>
              }
            }
          </div>

          <div class="mb-4">
            <label for="new-password" class="form-label">New password</label>
            <div class="position-relative">
              <input id="new-password" [type]="showNewPassword ? 'text' : 'password'" class="form-control ps-2" placeholder="Enter new password" formControlName="newPassword" aria-describedby="passwordHelpBlock"
                     [class.is-invalid]="changePasswordForm.invalid && (newPassword.dirty || newPassword.touched)">
              <i role="button"
                 class="bi show-password-icon"
                 [ngClass]="showNewPassword ? 'bi-eye-slash-fill' : 'bi-eye-fill'"
                 (click)="toggleShowNewPassword()"
                 tabindex="0"
                 (keyup.space)="toggleShowNewPassword()"
                 (keyup.enter)="toggleShowNewPassword()"
                 [attr.aria-label]="showNewPassword ? 'Hide password' : 'Show password'">
                {{showNewPassword ? "Hide" : "Show"}} Password
              </i>
            </div>
            <div id="passwordHelpBlock" class="form-text text-reset">
              Must be at least {{passwordMinLength}} characters
            </div>
            @if (newPassword.invalid && (newPassword.dirty || newPassword.touched)) {
              @if (newPassword.hasError('required')) {
                <div class="validation-error">New password is required</div>
              } @else if (newPassword.hasError('minlength')) {
                <div class="validation-error">Password is too short</div>
              }
            } @else if (changePasswordForm.hasError('passwordsDontMatch') && (newPassword.dirty || newPassword.touched)) {
              <div class="validation-error">Passwords must match</div>
            }
          </div>

          <div class="mb-4">
            <label for="confirm-new-password" class="form-label">Confirm new password</label>
            <input id="confirm-new-password" type="password" class="form-control ps-2" placeholder="Confirm new password" formControlName="confirmNewPassword"
                   [class.is-invalid]="changePasswordForm.invalid && (confirmNewPassword.dirty || confirmNewPassword.touched)">
            @if (confirmNewPassword.invalid && (confirmNewPassword.dirty || confirmNewPassword.touched)) {
              @if (confirmNewPassword.hasError('required')) {
                <div class="validation-error">Confirm new password is required</div>
              }
            }
          </div>

          <p class="my-3 fs-5" [ngClass]="changePasswordSuccess ? 'validation-success' : 'validation-error'">{{passwordMessage}}</p>
          <button type="submit" class="btn btn-primary button" [disabled]="changePasswordForm.invalid">Change</button>
        </form>
      </div>
    </div>

    <div class="tab-pane" id="social-tab-pane" role="tabpanel" aria-labelledby="social-tab" tabindex="0">
      <h3 class="mb-4">Social</h3>
      @if (profileSettings) {
        @for (social of profileSettings.socialAccounts; track social.socialId) {
          <div class="social-row">
            <iconify-icon [attr.icon]="social.icon" width="40" height="40"></iconify-icon>
            <span class="social-name">{{social.socialName}}</span>
            <input type="text" class="form-control social-input ps-2" [(ngModel)]="social.handle">

            @if (social.handle) {
              <button type="button" class="btn btn-primary d-flex align-items-center gap-2 button" (click)="removeSocialAccount(social)">
                <span>Remove</span>
                <img ngSrc="x.svg" alt="" height="25" width="25">
              </button>
            }
          </div>
        }
        <p class="mt-3 fs-5 validation-success">{{socialMessage}}</p>
        <button type="button" [disabled]="isSocialSaveDisabled()" class="btn btn-primary mt-4 button" (click)="addSocialAccounts()">Save changes</button>
      }
    </div>
  </div>
</div>
